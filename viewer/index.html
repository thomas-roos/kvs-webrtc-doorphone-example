<!DOCTYPE html>
<html>
<head>
    <title>Doorbell Viewer</title>
    <style>
        body { font-family: Arial; padding: 5px; margin: 0; max-width: 800px; margin: 0 auto; }
        #config-panel { background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        #config-panel input { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        #config-panel button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #viewer-panel { display: none; }
        #video { width: 100%; height: 100%; background: #000; display: block; transform: rotate(270deg) !important; }
        #video:fullscreen { transform: rotate(270deg) !important; }
        #video:-webkit-full-screen { transform: rotate(270deg) !important; }
        #video:-moz-full-screen { transform: rotate(270deg) !important; }
        #video-container { width: 100%; max-width: 1280px; height: auto; aspect-ratio: 16/9; overflow: hidden; margin: 10px auto; background: #000; }
        #video-container:fullscreen { background: #000; }
        #video-container:-webkit-full-screen { background: #000; }
        #video-container:-moz-full-screen { background: #000; }
        #ring-notification { display: none; padding: 15px; background: #4CAF50; color: white; margin: 10px 0; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        #closeCall { background: #f44336; color: white; border: none; }
        #openDoor { background: #2196F3; color: white; border: none; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Video Doorbell Viewer</h1>

    <div id="config-panel">
        <h2>Configuration</h2>
        <label>AWS Region:</label>
        <select id="region" onchange="updateIoTEndpoint()">
            <option value="us-east-1">US East (N. Virginia)</option>
            <option value="us-west-2">US West (Oregon)</option>
            <option value="eu-central-1" selected>Europe (Frankfurt)</option>
            <option value="eu-west-1">Europe (Ireland)</option>
            <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
            <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
        </select>

        <label>IoT Endpoint:</label>
        <input type="text" id="iotEndpoint" placeholder="Auto-filled based on region" readonly style="background: #f9f9f9;">

        <label>KVS Channel ARN:</label>
        <input type="text" id="channelArn" placeholder="arn:aws:kinesisvideo:...">

        <label>AWS Access Key ID:</label>
        <input type="text" id="accessKeyId" placeholder="AKIA...">

        <label>AWS Secret Access Key:</label>
        <input type="password" id="secretAccessKey" placeholder="Secret key">

        <label>AWS Session Token <small>(optional)</small>:</label>
        <input type="password" id="sessionToken" placeholder="Session token (leave empty if not using temporary credentials)">

        <br><br>
        <button onclick="saveConfigAndConnect()">Connect</button>
    </div>

    <div id="viewer-panel">
        <div id="ring-notification">
            <button id="pickup-btn">Pick Up</button>
        </div>
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
        </div>
        <div>
            <button id="closeCall" onclick="closeCall()">Close Call</button>
            <button id="openDoor" onclick="openDoor()">Open Door</button>
            <button id="micToggle" onclick="toggleMicrophone()" style="background: green; color: white;">Mic ON</button>
            <button onclick="toggleFullscreen()" style="background: purple; color: white; border: none;">Fullscreen</button>
            <button onclick="startViewer()" style="background: orange;">Test WebRTC (No MQTT)</button>
        </div>
        <div id="status">Connecting...</div>
        <div id="console-log" style="background: #f0f0f0; padding: 10px; margin: 10px 0; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; border: 1px solid #ccc; white-space: pre-wrap;"></div>
    </div>

    <script>
        // IoT endpoints for each region
        const iotEndpoints = {
            'us-east-1': 'a20mxm1jboggkj-ats.iot.us-east-1.amazonaws.com',
            'us-west-2': 'a20mxm1jboggkj-ats.iot.us-west-2.amazonaws.com',
            'eu-central-1': 'a20mxm1jboggkj-ats.iot.eu-central-1.amazonaws.com',
            'eu-west-1': 'a20mxm1jboggkj-ats.iot.eu-west-1.amazonaws.com',
            'ap-southeast-1': 'a20mxm1jboggkj-ats.iot.ap-southeast-1.amazonaws.com',
            'ap-northeast-1': 'a20mxm1jboggkj-ats.iot.ap-northeast-1.amazonaws.com'
        };
        
        function updateIoTEndpoint() {
            const region = document.getElementById('region').value;
            const endpoint = iotEndpoints[region] || '';
            document.getElementById('iotEndpoint').value = endpoint;
        }
        
        // Set initial endpoint on page load
        window.onload = function() {
            updateIoTEndpoint();
        };
        
        // Ensure crypto.subtle is available for WebRTC signing
        if (!window.crypto || !window.crypto.subtle) {
            console.warn('Crypto API not available, this may cause WebRTC signing issues');
        }
        
        function toggleFullscreen() {
            const container = document.getElementById('video-container');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.log('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Force rotation in fullscreen
        document.addEventListener('fullscreenchange', function() {
            const video = document.getElementById('video');
            if (document.fullscreenElement) {
                video.style.transform = 'rotate(270deg)';
            }
        });
    </script>
    <script src="./amazon-kinesis-video-streams-webrtc-sdk-js/examples/aws-sdk-3.758.0-kvswebrtc.js"></script>
    <script src="./aws-iot-browser-bundle.js"></script>
    <script src="./amazon-kinesis-video-streams-webrtc-sdk-js/dist/kvs-webrtc.min.js"></script>
    <script src="working-viewer.js"></script>
</body>
</html>
