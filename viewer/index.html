<!DOCTYPE html>
<html>
<head>
    <title>Doorbell Viewer</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        #config-panel { background: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        #config-panel input { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        #config-panel button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #viewer-panel { display: none; }
        #video { width: 100%; max-width: 640px; background: #000; display: block; }
        #ring-notification { display: none; padding: 20px; background: #4CAF50; color: white; margin: 10px 0; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        #closeCall { background: #f44336; color: white; border: none; }
        #openDoor { background: #2196F3; color: white; border: none; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Video Doorbell Viewer</h1>

    <div id="config-panel">
        <h2>Configuration</h2>
        <label>AWS Region:</label>
        <input type="text" id="region" placeholder="eu-central-1" value="eu-central-1">

        <label>IoT Endpoint:</label>
        <input type="text" id="iotEndpoint" placeholder="xxxxx.iot.eu-central-1.amazonaws.com">

        <label>KVS Channel ARN:</label>
        <input type="text" id="channelArn" placeholder="arn:aws:kinesisvideo:...">

        <label>AWS Access Key ID:</label>
        <input type="text" id="accessKeyId" placeholder="AKIA...">

        <label>AWS Secret Access Key:</label>
        <input type="password" id="secretAccessKey" placeholder="Secret key">

        <label>AWS Session Token <small>(optional)</small>:</label>
        <input type="password" id="sessionToken" placeholder="Session token (leave empty if not using temporary credentials)">

        <br><br>
        <button onclick="saveConfigAndConnect()">Connect</button>
    </div>

    <div id="viewer-panel">
        <div id="ring-notification">
            Someone is at the door!
            <button id="pickup-btn">Pick Up</button>
        </div>
        <video id="video" autoplay playsinline></video>
        <div>
            <button id="closeCall" onclick="closeCall()">Close Call</button>
            <button id="openDoor" onclick="openDoor()">Open Door</button>
            <button onclick="startViewer()" style="background: orange;">Test WebRTC (No MQTT)</button>
        </div>
        <div id="status">Connecting...</div>
        <div id="console-log" style="background: #f0f0f0; padding: 10px; margin: 10px 0; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; border: 1px solid #ccc;"></div>
    </div>

    <script>
        // Ensure crypto.subtle is available for WebRTC signing
        if (!window.crypto || !window.crypto.subtle) {
            console.warn('Crypto API not available, this may cause WebRTC signing issues');
        }
    </script>
    <script src="./amazon-kinesis-video-streams-webrtc-sdk-js/examples/aws-sdk-3.758.0-kvswebrtc.js"></script>
    <script src="./aws-iot-browser-bundle.js"></script>
    <script src="./amazon-kinesis-video-streams-webrtc-sdk-js/dist/kvs-webrtc.min.js"></script>
    <script src="working-viewer.js"></script>
</body>
</html>
